<button id="search-trigger" class="search-trigger-button" aria-label="Open search">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
</button>

<div id="search-overlay" class="search-overlay">
    <button id="search-close" class="search-close-button" aria-label="Close search">&times;</button>
    <div class="search-content">
        <input type="text" id="search-input" placeholder="Type to search..." autocomplete="off">
        <div id="search-results" class="search-results-container"></div>
    </div>
</div>

<script>
    // Control to prevent this code block from running multiple times
    if (typeof window.jekyllSearchInit === 'undefined') {
        window.jekyllSearchInit = true;

        document.addEventListener('DOMContentLoaded', function () {
            // Select required HTML elements
            const searchTrigger = document.getElementById('search-trigger');
            const searchOverlay = document.getElementById('search-overlay');
            const searchClose = document.getElementById('search-close');
            const searchInput = document.getElementById('search-input');
            const searchResults = document.getElementById('search-results');

            let lunrIndex, documentsStore;

            // Load search data (search.json) and prepare Lunr index
            fetch('{{ "/search.json" | relative_url }}')
                .then(response => response.json())
                .then(data => {
                    documentsStore = data;
                    lunrIndex = lunr(function () {
                        this.ref('url');
                        this.field('title', { boost: 10 });
                        this.field('content');
                        this.field('tags');
                        
                        data.forEach(doc => {
                            this.add(doc);
                        });
                    });
                });

            // Search function
            function performSearch() {
                const query = searchInput.value;
                if (!query || !lunrIndex) {
                    searchResults.innerHTML = '';
                    return;
                }
                const results = lunrIndex.search(query + '*'); // Add wildcard for more flexible search
                displayResults(results);
            }

            // Function to display results on screen
            function displayResults(results) {
                if (results.length) {
                    let output = '';
                    results.forEach(result => {
                        const item = documentsStore.find(doc => doc.url === result.ref);
                        if (item) {
                            output += `
                                <a href="{{ site.baseurl }}${item.url}" class="search-result-item">
                                    <div class="search-result-title">${item.title}</div>
                                    <p class="search-result-excerpt">${item.content.substring(0, 150)}...</p>
                                </a>
                            `;
                        }
                    });
                    searchResults.innerHTML = output;
                } else {
                    searchResults.innerHTML = '<p class="search-result-excerpt">No results found...</p>';
                }
            }

            // Event Listeners
            searchTrigger.addEventListener('click', function () {
                searchOverlay.classList.add('is-active');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
                searchInput.focus(); // Auto-focus on search input
            });

            function closeSearch() {
                searchOverlay.classList.remove('is-active');
                document.body.style.overflow = '';
            }

            searchClose.addEventListener('click', closeSearch);
            searchInput.addEventListener('input', performSearch);

            // Close search when Esc key is pressed
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && searchOverlay.classList.contains('is-active')) {
                    closeSearch();
                }
            });
        });
    }
</script>